---
layout: post
title: 'Springbootäº‹åŠ¡é—®é¢˜'
subtitle: 'äº‹åŠ¡æäº¤å›æ»šé—®é¢˜'
date: 2020-2-14
categories: æŠ€æœ¯
tags: springboot Transaction
---


# Springboot äº‹åŠ¡

ä»Šå¤©å†™é¡¹ç›®å‘ç°ä¸€ä¸ªé—®é¢˜,åœ¨æ·»åŠ ç”¨æˆ·çš„åŠŸèƒ½ä¸­ï¼Œé€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„

```
ï¼ˆæ·»åŠ äº†äº‹åŠ¡@Transactionalï¼‰
æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·åï¼ˆå¦åˆ™ç»§ç»­ï¼‰
---
æ·»åŠ ç”¨æˆ·è¡¨ç”¨æˆ·ä¿¡æ¯
---
æ·»åŠ ç”¨æˆ·è§’è‰²è¡¨ä¿¡æ¯
---
å°†ç”¨æˆ·åæ·»åŠ ç¼“å­˜
---
```

ä½†è¿™ä¹ˆå†™å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœä¸­é—´çš„æ·»åŠ æ“ä½œå­˜åœ¨é—®é¢˜ï¼Œè‡ªåŠ¨å›æ»šåï¼Œæ•°æ®åº“æ²¡æœ‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä½†æ˜¯redisä¸­å´æœ‰ï¼Œè¯¥ç”¨æˆ·å°±ä¸èƒ½å†æ¬¡æ³¨å†Œäº†ï¼Œå°½ç®¡æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œåæ¥æ‰¾åˆ°äº†è§£å†³åŠæ³•~~ï¼ˆæ€ªä¸å¾—ä»£ç æç¤º Alibaba Java Coding GuideLinesï¼‰~~

## ***\*äº‹åŠ¡åœºæ™¯ä¸­ï¼ŒæŠ›å‡ºå¼‚å¸¸è¢«catchåï¼Œå¦‚æœéœ€è¦å›æ»šï¼Œä¸€å®šè¦æ‰‹åŠ¨å›æ»šäº‹åŠ¡ã€‚\****

è‡ªåŠ¨æäº¤ï¼Œæ‰‹åŠ¨å›æ»šï¼Œå¤§æ¦‚é€»è¾‘æ˜¯è¿™æ ·çš„

```
ï¼ˆæ·»åŠ äº†äº‹åŠ¡@Transactionalï¼‰
é…ç½®äº‹åŠ¡ç®¡ç†å™¨
---
æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·åï¼ˆå¦åˆ™ç»§ç»­ï¼‰
---
try
æ·»åŠ ç”¨æˆ·è¡¨ç”¨æˆ·ä¿¡æ¯
æ·»åŠ ç”¨æˆ·è§’è‰²è¡¨ä¿¡æ¯
å°†ç”¨æˆ·åæ·»åŠ ç¼“å­˜
catch
å›æ»š
åˆ ç¼“å­˜
---
```



ä»£ç å¦‚å›¾

```java
/**
     * è‡ªåŠ¨æäº¤ï¼Œæ‰‹åŠ¨å›æ»š
     * @param user
     * @return
     * @throws XJWCException
     */
    @Override
    @Transactional
    public JSONResult insertUser(User user) throws XJWCException {
        // é…ç½®äº‹åŠ¡ç­–ç•¥
        DefaultTransactionDefinition def = new DefaultTransactionDefinition();
        def.setName("transaction");
        def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
        // è®¾ç½®çŠ¶æ€ç‚¹
        TransactionStatus status = dataSourceTransactionManager.getTransaction(def);
        //å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œæœªå‘½ä¸­å†æŸ¥è¯¢æ•°æ®åº“
        if (redisMapper.hsize(Constant.USER_PHONE_EXIST) != 0) {
            if (redisMapper.hHasKey(Constant.USER_PHONE_EXIST, user.getPhone())) {
                throw new XJWCException("è¯¥å·ç å·²è¢«æ³¨å†Œï¼Œè¯·é‡è¯•");
            }
        } else {
            int num = userMapper.findByPhone(user.getPhone());
            System.out.println(num);
            if (0 < num) {
                throw new XJWCException("è¯¥å·ç å·²è¢«æ³¨å†Œï¼Œè¯·é‡è¯•");
            }
        }
        String id = GetRandom.getUUID();
        user.setUserId(id);
        user.setRole(2);
        //å¯†ç åŠ å¯†å­˜å‚¨
        Object o = MD5.MD5(user.getPhone(), user.getPassword());
        user.setPassword(String.valueOf(o));
        try{
            userMapper.insertUser(user);
            userMapper.insertUserRole(id, 2);
            redisMapper.hset(Constant.USER_PHONE_EXIST, user.getPhone(), 1);
            logger.info("æ·»åŠ ç”¨æˆ·æˆåŠŸ" + JsonUtil.getJsonString(user));
        } catch (Exception ex) {
            logger.error("æ·»åŠ ç”¨æˆ·å¤±è´¥ ï¼š " + ex.getMessage());
            dataSourceTransactionManager.rollback(status);
            redisMapper.hdel(Constant.USER_PHONE_EXIST, user.getPhone());
            throw new XJWCException("æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•ï¼");
        }
        return JSONResult.ok(1);
    }
```

## é˜¿é‡Œçˆ¸çˆ¸ğŸ®ğŸºï¼

~~æˆ‘è¿˜æ˜¯å¤ªèœäº†~~